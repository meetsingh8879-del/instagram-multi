<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Waleed ‚Äî Instagram DM Sender</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      :root{
        --primary: #0d6efd;
        --accent: #6f42c1;
        --muted: #6c757d;
      }
      body {
        background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
        min-height: 100vh;
        color: #212529;
      }
      .brand {
        font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial;
        font-weight: 700;
        letter-spacing: .4px;
      }
      .card-hero {
        border-radius: 14px;
        box-shadow: 0 8px 30px rgba(44, 62, 80, 0.08);
      }
      .small-muted { color: var(--muted); font-size: .9rem; }
      .progress { height: 1.2rem; border-radius: 8px; }
      .footer-note { font-size: .85rem; color: var(--muted); }
      .file-label { cursor: pointer; }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-9">
          <div class="card card-hero p-4 mb-4">
            <div class="d-flex align-items-center gap-3">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:56px;height:56px;font-weight:700;">
                W
              </div>
              <div>
                <h2 class="mb-0 brand">Waleed ‚Äî Instagram DM Sender</h2>
                <div class="small-muted">Send messages from a .txt file. Monitor progress in real time.</div>
              </div>
            </div>
          </div>

          {% if error %}
            <div class="alert alert-danger" role="alert">{{ error }}</div>
          {% endif %}

          {% if message and not job_id %}
            <div class="alert alert-info" role="alert">{{ message }}</div>
          {% endif %}

          <div class="card mb-4">
            <div class="card-body">
              {% if job_id %}
                <h5 class="card-title">Job <span class="badge bg-secondary">{{ job_id }}</span></h5>
                <p class="small-muted">Status URL: <a href="{{ status_url }}" target="_blank">{{ status_url }}</a></p>

                <div class="mb-3">
                  <label class="form-label">Progress</label>
                  <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <div id="job-progress" class="progress-bar progress-bar-striped bg-success" style="width: 0%">0%</div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <pre id="job-status" class="p-3 bg-light rounded" style="white-space:pre-wrap;">Queued...</pre>
                </div>

                <div class="d-flex gap-2">
                  <a href="/" class="btn btn-outline-secondary">Start another job</a>
                </div>

                <script>
                  const statusUrl = "{{ status_url }}";
                  const progressEl = document.getElementById('job-progress');
                  const statusEl = document.getElementById('job-status');

                  async function poll() {
                    try {
                      const res = await fetch(statusUrl);
                      if (!res.ok) throw new Error('Status fetch failed: ' + res.status);
                      const data = await res.json();
                      const progress = data.progress ?? 0;
                      const status = data.message ?? data.status ?? JSON.stringify(data);

                      progressEl.style.width = progress + '%';
                      progressEl.textContent = progress + '%';
                      statusEl.textContent = status + "\n\n" + "State: " + (data.status || 'unknown');

                      if (data.status !== 'done' && data.status !== 'error') {
                        setTimeout(poll, 1500);
                      } else {
                        // final
                        if (data.status === 'done') {
                          progressEl.classList.remove('bg-success');
                          progressEl.classList.add('bg-primary');
                        } else {
                          progressEl.classList.remove('bg-success');
                          progressEl.classList.add('bg-danger');
                        }
                      }
                    } catch (err) {
                      statusEl.textContent = 'Error fetching status: ' + err;
                      setTimeout(poll, 3000);
                    }
                  }

                  // start polling
                  poll();
                </script>

              {% else %}
                <form method="post" enctype="multipart/form-data" class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Instagram Username</label>
                    <input type="text" name="username" class="form-control" required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-control" required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Recipient (username or group)</label>
                    <input type="text" name="recipient" class="form-control" required>
                    <div class="form-text">Use exact username or group name. If group, include 'group' in name for best-effort detection.</div>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Interval (seconds)</label>
                    <input type="number" name="interval" class="form-control" value="5" min="1">
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Prefix (haters_name)</label>
                    <input type="text" name="haters_name" class="form-control" placeholder="Optional">
                  </div>

                  <div class="col-12">
                    <label class="form-label file-label">Messages file (.txt)</label>
                    <input class="form-control" type="file" name="message_file" accept=".txt" required>
                    <div class="form-text">One message per line. UTF-8 encoded.</div>
                  </div>

                  <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Send Messages</button>
                  </div>
                </form>
              {% endif %}
            </div>
          </div>

          <div class="text-center footer-note">
            <div>Secure your credentials ‚Äî use HTTPS and avoid committing secrets.</div>
            <div class="mt-2">Copilot is powered by AI, so mistakes are possible. Leave a comment via the üëç üëé to share your feedback and help improve the experience.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (optional for some components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
